#!/usr/bin/env sh
# shellcheck disable=SC2086,SC1090,SC2154
# command_maim_args doesn't work when quoted, so SC2086 is disabled

# rewrite of Luke Smith's maimpick
# https://github.com/LukeSmithxyz/voidrice/blob/master/.local/bin/maimpick
# his dotfiles can be accessed here: https://github.com/LukeSmithxyz/voidrice

# check that the library file is readable. if it is, source it so its
# functions are available. if not, exit due to potentially unpredictable
# behavior.
library="${HOME}/.local/bin/common.sh"
if [ -r "${library}" ]; then
  . "${library}"
else
  cat >&2 <<EOF
${library} doesn't exist or isn't readable.
${0##*/} may not function correctly without it; exiting for safety.
EOF
  exit 1
fi

cur_date() {
  date '+%Y%m%d-%H%M%S'
}

yankpic() {
  yank -t image/png || err 'Unable to copy selection to clipboard.'
}

maim_sel_save() {
  filename="selected-$(cur_date).png"
  maim ${common_maim_args} -s "${savedir}/${filename}"
}

maim_sel_copy() {
  maim ${common_maim_args} -s | yankpic
}

maim_cur_save() {
  filename="window-$(cur_date).png"
  maim ${common_maim_args} -i "$(xdotool getactivewindow)" \
    "${savedir}/${filename}"
}

maim_cur_copy() {
  maim ${common_maim_args} -i "$(xdotool getactivewindow)" \
    | yankpic
}

maim_full_save() {
  filename="full-$(cur_date).png"
  maim ${common_maim_args} "${savedir}/${filename}"
}

maim_full_copy() {
  maim ${common_maim_args} | yankpic
}

present_options() {
  case "$(menu -l 6 -p "Screenshot which area?")" in
    'a selected area')        maim_sel_save           ;;
    'current window')         maim_cur_save           ;;
    'full screen')            maim_full_save          ;;
    'a selected area (copy)') maim_sel_copy           ;;
    'current window (copy)')  maim_cur_copy           ;;
    'full screen (copy)')     maim_full_copy          ;;
    *)                        err "Not a valid area." ;;
  esac
}

main() {
  common_maim_args='-d 1 -u -q -B'
  savedir="${HOME}/screenshots"
  import_colors
  present_options <<'EOF'
a selected area
current window
full screen
a selected area (copy)
current window (copy)
full screen (copy)
EOF
}

main
