#!/usr/bin/env sh
# shellcheck disable=SC1090

# rewrite of Luke Smith's maimpick
# https://github.com/LukeSmithxyz/voidrice/blob/master/.local/bin/maimpick
# his dotfiles can be accessed here: https://github.com/LukeSmithxyz/voidrice


err() {
  printf '%s\n' "$*" >&2
  exit 1
}


check_deps() {
  while read -r dependency; do

    if [ -x "$(command -v -- "${dependency}")" ]; then
      continue

    else
      err "${dependency} not found in PATH or not executable."

    fi

  done
}


import_colors_sh() {
  COLORS_SH="${XDG_CACHE_HOME:=${HOME}/.cache}/wal/colors.sh"

  if ! [ -r "${COLORS_SH}" ]; then
    echo "${COLORS_SH} is not readable." >&2

  elif ! [ -f "${COLORS_SH}" ]; then
    echo "${COLORS_SH} is not a file." >&2

  # passed sanity checks, so source the file
  else
    . "${COLORS_SH}"

  fi
}


menu() {
  dmenu -i -fn 'mono-12'       \
  -nb "${background:=#040516}" \
  -nf "${color3:=#9974e7}"     \
  -sb "${background:=#040516}" \
  -sf "${foreground:=#e0cef3}" \
  "$@"
}


yankpic() {
  xclip -selection clipboard -t image/png \
    || err 'Unable to copy image data to clipboard.'
}


# --hide-cursor, --quiet, --capturebackground, --delay
maim_with_flags() {
  maim -uqBd 0.5 "$@"
}


present_options() {
  case "$(menu -l "${num_of_opts}" -p "Screenshot which area?")" in

    'a selected area')
      filename="selected-$(date '+%Y%m%d-%H%M%S').png"
      readonly filename

      maim_with_flags -s -- "${savedir}/${filename}"

      ;;

    'current window')
      filename="window-$(date '+%Y%m%d-%H%M%S').png"
      readonly filename

      maim_with_flags -i "$(xdotool getactivewindow)" -- "${savedir}/${filename}"

      ;;

    'full screen')
      filename="full-$(date '+%Y%m%d-%H%M%S').png"
      readonly filename

      maim_with_flags -- "${savedir}/${filename}"

      ;;

    'a selected area (copy)')
      maim_with_flags -s | yankpic

      ;;

    'current window (copy)')
      maim_with_flags -i "$(xdotool getactivewindow)" | yankpic

      ;;

    'full screen (copy)')
      maim_with_flags | yankpic

      ;;

    *)
      err 'Not a valid area.'

      ;;

  esac
}


[ -z "${DISPLAY}" ] && err "${0##*/} requires a graphical environment."

check_deps <<'EOF'
dmenu
maim
xclip
xdotool
EOF

import_colors_sh

readonly options='a selected area
current window
full screen
a selected area (copy)
current window (copy)
full screen (copy)'

readonly savedir="${HOME}/screenshots"

num_of_opts="$(echo "${options}" | wc -l)"
readonly num_of_opts

echo "${options}" | present_options
