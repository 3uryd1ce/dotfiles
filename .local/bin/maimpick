#!/usr/bin/env ksh
set -e

# rewrite of Luke Smith's maimpick
# his dotfiles can be accessed here: https://github.com/LukeSmithxyz/voidrice

common_maim_args="-d 1 -u -q -B"
savedir="${HOME}/screenshots"

sec_print () {
  printf "%s\\n" "$@"
}

err () {
  sec_print "[$(date +'%Y-%m-%d--%H:%M:%S')]: $*" >&2
  exit 1
}

import_colors () {
  . "${HOME}/.cache/wal/colors.sh"
}

menu () {
  dmenu -i -l 6 \
    -fn 'mono-20' \
    -nb "${color0}" \
    -nf "${color3}" \
    -sb "${color0}" \
    -sf "${color7}" \
    -p 'Screenshot which area?'
}

print_options () {
cat <<EOF
a selected area
current window
full screen
selected area (copy)
current window (copy)
full screen (copy)
EOF
}

cur_date () {
  date '+%Y%m%d-%H%M%S'
}

yank () {
  xclip -selection clipboard -t image/png || err "Couldn't copy to clipboard."
}

maim_sel_save () {
  filename="selected-$(cur_date).png"
  maim ${common_maim_args} -s "${savedir}/${filename}"
}

maim_sel_copy () {
  maim ${common_maim_args} -s | yank
}

maim_cur_save () {
  filename="window-$(cur_date).png"
  maim ${common_maim_args} -i "$(xdotool getactivewindow)" \
    "${savedir}/${filename}"
}

maim_cur_copy () {
  maim ${common_maim_args} -i "$(xdotool getactivewindow)" \
    | yank
}

maim_full_save () {
  filename="full-$(cur_date).png"
  maim ${common_maim_args} "${savedir}/${filename}"
}

maim_full_copy () {
  maim ${common_maim_args} | yank
}

present_options () {
  case "$(print_options | menu)" in
    "a selected area") maim_sel_save ;;
    "current window") maim_cur_save ;;
    "full screen") maim_full_save ;;
    "a selected area (copy)") maim_sel_copy ;;
    "current window (copy)") maim_cur_copy ;;
    "full screen (copy)") maim_full_copy ;;
  esac
}

main () {
  import_colors || err "Unable to import colors."
  present_options || err "Unable to present options."
}

main
