#!/usr/bin/env sh
# shellcheck disable=SC1090

# rewrite of Luke Smith's maimpick
# https://github.com/LukeSmithxyz/voidrice/blob/master/.local/bin/maimpick
# his dotfiles can be accessed here: https://github.com/LukeSmithxyz/voidrice

# check that the library file is readable. if it is, source it so its
# functions are available. if not, exit due to potentially unpredictable
# behavior.
readonly library="${HOME}/.local/bin/common.sh"
if [ -r "${library}" ]; then
  . "${library}"
else
  cat >&2 <<EOF
${library} doesn't exist or isn't readable.
${0##*/} may not function correctly without it; exiting for safety.
EOF
  exit 1
fi

cur_date() {
  date '+%Y%m%d-%H%M%S'
}

yankpic() {
  yank -t image/png || err 'Unable to copy selection to clipboard.'
}

# --hide-cursor, --quiet, --capturebackground, --delay
maim_with_flags() {
  maim -uqBd 0.5 "$@"
}

maim_sel_save() {
  filename="selected-$(cur_date).png" && readonly filename
  maim_with_flags -s -- "${savedir}/${filename}"
}

maim_sel_copy() {
  maim_with_flags -s | yankpic
}

maim_cur_save() {
  filename="window-$(cur_date).png" && readonly filename
  maim_with_flags -i "$(xdotool getactivewindow)" -- \
    "${savedir}/${filename}"
}

maim_cur_copy() {
  maim_with_flags -i "$(xdotool getactivewindow)" \
    | yankpic
}

maim_full_save() {
  filename="full-$(cur_date).png" && readonly filename
  maim_with_flags -- "${savedir}/${filename}"
}

maim_full_copy() {
  maim_with_flags | yankpic
}

present_options() {
  case "$(menu -l "${num_of_opts}" -p "Screenshot which area?")" in
    'a selected area')        maim_sel_save                                   ;;
    'current window')         maim_cur_save                                   ;;
    'full screen')            maim_full_save                                  ;;
    'a selected area (copy)') maim_sel_copy && sleep 10 && clear_clip notify  ;;
    'current window (copy)')  maim_cur_copy && sleep 10 && clear_clip notify  ;;
    'full screen (copy)')     maim_full_copy && sleep 10 && clear_clip notify ;;
    *)                        err 'Not a valid area.'                         ;;
  esac
}

prereqs() {
  check_grafix
  check_deps <<'EOF'
dmenu
maim
xclip
xdotool
EOF
  import_colors_sh
}

main() {
  prereqs
  readonly options='a selected area
current window
full screen
a selected area (copy)
current window (copy)
full screen (copy)'
  readonly savedir="${HOME}/screenshots"
  num_of_opts="$(echo "${options}" | wc -l)" && readonly num_of_opts
  echo "${options}" | present_options
}

main
