#!/usr/bin/env sh

MPV="$(command -vp mpv)"
OS="$(uname)"
PROGRAM_NAME="${0##*/}"

# disable core dumps
#
# currently there is an issue where mpv(1) reliably dumps a core on
# exit.
#
# see https://marc.info/?t=162020293900011&r=1&w=2

# also, disable xcompmgr(1) during playback since it seems to cause
# screen tearing with modesetting(4)

# since this is only an issue on OpenBSD, do an OS check and don't worry
# that it's not POSIX compatible since sh(1) on OpenBSD is secretly
# ksh(1).
#
# shellcheck disable=SC3045
if [ "${OS}" = 'OpenBSD' ]; then
  ulimit -c 0
  [ "${PROGRAM_NAME}" = 'mpv' ] && pkill xcompmgr
fi


case "${PROGRAM_NAME}" in
  'mpv')  "${MPV}" "$@"            ;;
  'mpva') "${MPV}" --no-video "$@" ;;
esac


if [ "${OS}" = 'OpenBSD' ] && [ "${PROGRAM_NAME}" = 'mpv' ]; then
  xcompmgr &
fi
