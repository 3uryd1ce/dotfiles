#!/bin/sh
# Written in 2020 by Lucas
# Modified in 2021-2022 by Ashlen
# CC0 1.0 Universal/Public domain - No rights reserved
#
# To the extent possible under law, the author(s) have dedicated all
# copyright and related and neighboring rights to this software to the
# public domain worldwide. This software is distributed without any
# warranty. You should have received a copy of the CC0 Public Domain
# Dedication along with this software. If not, see
# <http://creativecommons.org/publicdomain/zero/1.0/>.


# this script is meant to be run automatically (via cron(8) or
# .xsession, for instance) to keep element-web updated in
# ELEMENT_WEB_UI_DIR


make_release_url() {
	printf "https://${GH_API}/repos/%s/%s/releases/latest\n" "$1" "$2"
}


check_deps() {
	while read -r dependency; do

		[ -x "$(command -v -- "${dependency}")" ] \
			|| err "${dependency} not found in PATH or not executable."

	done
}


check_deps <<'EOF'
ftp
jq
perl
EOF


: "${GH_API:=api.github.com}"
: "${XDG_BIN_HOME:=${HOME}/.local/bin}"
: "${INSTALL_SCRIPT:=${XDG_BIN_HOME}/inst-elemweb}"


VERSION="$(ftp -VMno - "$(make_release_url vector-im element-web)" \
	| jq -er '.name | select(test("^v[0-9]+\\.[0-9]+\\.[0-9]+-rc") | not)')" \
	|| exit 1


readonly ELEMENT_WEB_UI_DIR='/var/www/htdocs/element-web'
export ELEMENT_WEB_UI_DIR

read -r CURRENT_VERSION <"${ELEMENT_WEB_UI_DIR}/element/version"
readonly CURRENT_VERSION="v${CURRENT_VERSION}"
perl -e "exit !(${VERSION} gt ${CURRENT_VERSION})" || exit 1


if "${INSTALL_SCRIPT}" "${VERSION}"; then
	printf '%s: element-web updated to %s\n' "${0##*/}" "${VERSION}" >&2

else
	printf '%s: failed to update element-web to %s\n' "${0##*/}" "${VERSION}" >&2

fi
