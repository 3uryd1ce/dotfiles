#!/bin/sh
# Copyright (c) 2020-2022 Ashlen <eurydice@riseup.net>

# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.

# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

set -eu


# Disable xcompmgr(1) during playback since it seems to cause
# screen tearing with modesetting(4).

readonly PROGRAM_NAME="${0##*/}"

err() {
	printf '%s\n' "$*" >&2
	exit 1
}

usage() {
	err "$0 is a wrapper script, see mpv(1) for usage details."
}


[ -n "${DISPLAY}" ] || err "${PROGRAM_NAME} requires a graphical environment."
[ -n "$*" ] || usage
MPV="$(command -vp 'mpv')" || err 'mpv not found in PATH.'


case "${PROGRAM_NAME}" in
	'mpv')
		pkill xcompmgr
		"${MPV}" "$@"
		command -v 'xcompmgr' >/dev/null 2>&1 && xcompmgr >/dev/null 2>&1 &
		;;

	# workaround for screen tearing isn't needed if only playing audio
	'mpva')
		"${MPV}" \
			--no-keep-open \
			--no-resume-playback \
			--no-pause \
			--no-video "$@"
		;;

	*)
		err "${PROGRAM_NAME} is not an expected program name."
		;;
esac
