#!/usr/bin/env sh
set -e

MARKDOWNDIR=/home/ashlen/builds/website_md
WEBDIR=/home/ashlen/builds/website
SRVDIR=/var/www/htdocs/amissing.link
SSG=/home/ashlen/bin/ssg5

sec_print () {
  printf "%s\\n" "$1"
}

err () {
  sec_print "[$(date +'%Y-%m-%d--%H:%M:%S')]: $*" >&2
  exit 1
}

gen_site () {
  rm -f ${WEBDIR}/.files \
    && ${SSG} ${MARKDOWNDIR} ${WEBDIR} "aml: there's no place like /home" \
    "https://amissing.link" > /dev/null 2>&1 \
    && chown ashlen:ashlen ${WEBDIR}/.files
}

sync_and_chmod () {
  rsync -a --partial --delete -q ${WEBDIR}/ ${SRVDIR}/ \
    && find ${SRVDIR} -type f -execdir chmod 644 "{}" \; > /dev/null 2>&1 \
    && find ${SRVDIR} -type d -execdir chmod 755 "{}" \; > /dev/null 2>&1 \
    && chmod 755 ${SRVDIR} \
    && rcctl -f restart httpd > /dev/null \
    && sec_print "Web server synced."
}

webtest () {
  gen_site || err "Couldn't generate site."
  sync_and_chmod || err "Unable to sync web server."
}

webtest || err "Webtest failed."
