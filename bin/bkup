#!/usr/bin/env sh
set -e

DATE="$(date '+%Y-%m-%d')"
EXTENSION=".dump.bz2"
COMPRESSOR="bzip2"
COMPRESSOR_ARGS="-c"

sec_print () {
  printf "%s\\n" "$1"
}

err () {
  sec_print "[$(date +'%Y-%m-%d--%H:%M:%S')]: $*" >&2
  exit 1
}

bkup() {
/sbin/dump -0 -a -u -f - / \
  | "${COMPRESSOR}" ${COMPRESSOR_ARGS} \
  > /mnt/"${DATE}"/root"${EXTENSION}" &

/sbin/dump -0 -a -u -f - /var \
  | "${COMPRESSOR}" ${COMPRESSOR_ARGS} \
  > /mnt/"${DATE}"/var"${EXTENSION}" &

/sbin/dump -0 -a -u -f - /home \
  | "${COMPRESSOR}" ${COMPRESSOR_ARGS} \
  > /mnt/"${DATE}"/home"${EXTENSION}" &

/sbin/dump -0 -a -u -f - /usr/local \
  | "${COMPRESSOR}" ${COMPRESSOR_ARGS} \
  > /mnt/"${DATE}"/usr-local"${EXTENSION}" &

/sbin/dump -0 -a -u -f - /usr/X11R6 \
  | "${COMPRESSOR}" ${COMPRESSOR_ARGS} \
  > /mnt/"${DATE}"/usr-X11R6"${EXTENSION}" &

/sbin/dump -0 -a -u -f - /usr \
  | "${COMPRESSOR}" ${COMPRESSOR_ARGS} \
  > /mnt/"${DATE}"/usr"${EXTENSION}" &
wait
}

main () {
banner "bkup"
cat <<EOF

This script creates level 0 dumps of /root, /var, /home, /usr/local, /usr/X11R6,
and /usr. It compresses them using ${COMPRESSOR} and places the backups inside
/mnt in a folder named the current date. Is this acceptable?
EOF
read -r CONTINUE

if [ "${CONTINUE}" = "n" ]; then
  sec_print "Goodbye."
elif [ "${CONTINUE}" = "y" ]; then
  mkdir -p "/mnt/${DATE}" || err "Couldn't create backup directory."
  sec_print "Dumping filesystems..."
  bkup || err "Backup failed."
else
  err "You must answer with 'y' or 'n'."
fi
}

main
